name: Build and Release Chrome Extension

on:
  push:
    branches:
      - main # å½“æœ‰æ–°çš„æ¨é€åˆ°è¾¾ main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: ğŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*' # ä½¿ç”¨æœ€æ–°çš„ LTS ç‰ˆæœ¬çš„ Node.js

      # å®‰è£…é¡¹ç›®ä¾èµ–
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # æ„å»ºé¡¹ç›®
      - name: ğŸ—ï¸ Build project
        run: npm run build

      # ä» manifest.json è·å–ç‰ˆæœ¬å·
      # ä½¿ç”¨ Node.js è¯»å– public/manifest.json æ–‡ä»¶å¹¶è·å– version å­—æ®µ
      # å°†ç‰ˆæœ¬å·ä¿å­˜åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
      - name: ğŸ“„ Get version from manifest.json
        id: get_version
        run: |
          # ä½¿ç”¨ Node.js è¯»å– JSON æ–‡ä»¶å¹¶æ‰“å°ç‰ˆæœ¬å·
          VERSION=$(node -p "require('./public/manifest.json').version")
          # å°†ç‰ˆæœ¬å·è®¾ç½®åˆ° GITHUB_ENV ä¸­
          echo "EXTENSION_VERSION=$VERSION" >> $GITHUB_ENV
          echo "ğŸ‰ Found extension version: $VERSION"

      # æ‰“åŒ… build ç›®å½•ä¸º zip æ–‡ä»¶
      # ä½¿ç”¨ zip å‘½ä»¤å°† build ç›®å½•æ‰“åŒ…ï¼Œæ–‡ä»¶åä½¿ç”¨ç‰ˆæœ¬å·
      - name: âœ‰ï¸ Create zip package
        run: |
          # å®šä¹‰ zip æ–‡ä»¶åï¼Œä½¿ç”¨ä¹‹å‰è·å–çš„ç‰ˆæœ¬å·
          ZIP_FILE_NAME="${{ env.EXTENSION_VERSION }}.zip"
          # æ‰“åŒ… build ç›®å½•ï¼Œç”Ÿæˆ zip æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•
          zip -r "$ZIP_FILE_NAME" build/
          echo "ğŸ“¦ Created zip file: $ZIP_FILE_NAME"
        env:
          # ç¡®ä¿ EXTENSION_VERSION ç¯å¢ƒå˜é‡åœ¨è¿™ä¸ªæ­¥éª¤ä¸­å¯ç”¨
          EXTENSION_VERSION: ${{ env.EXTENSION_VERSION }}

      # åˆ›å»º GitHub Release
      # ä½¿ç”¨ softprops/action-gh-release@v1 action æ¥åˆ›å»º Release
      - name: ğŸ”– Create GitHub Release
        # æ·»åŠ ä¸€ä¸ª IDï¼Œä»¥ä¾¿åœ¨ description ä¸­å¼•ç”¨ Action çš„è¾“å‡ºï¼ˆå¦‚ previous_tagï¼‰
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # æŒ‡å®šè¦ä¸Šä¼ åˆ° Release çš„èµ„äº§æ–‡ä»¶
          files: ${{ env.EXTENSION_VERSION }}.zip
          # æŒ‡å®š Release çš„ Git Tag åç§°ï¼Œé€šå¸¸æ˜¯ç‰ˆæœ¬å·ï¼Œå‰é¢åŠ ä¸ª v æ˜¯æƒ¯ä¾‹
          tag_name: v${{ env.EXTENSION_VERSION }}
          # æŒ‡å®š Release çš„åç§°ï¼Œå¢åŠ ä¸€äº›è¡¨æƒ…ç¬¦å·å¢åŠ æ´»åŠ›
          name: âœ¨ v${{ env.EXTENSION_VERSION }} âœ¨
          # ç«‹å³å‘å¸ƒï¼Œä¸”ä¸æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬
          draft: false
          prerelease: false
          # è‡ªåŠ¨æŸ¥æ‰¾ä¸Šä¸€ä¸ª Release çš„ Tagï¼Œè¿™ä¸ªä¿¡æ¯å¯ä»¥åœ¨ description ä¸­ä½¿ç”¨
          find_previous_tag: true
          # æŒ‡å®š Release çš„æè¿°ä¿¡æ¯ï¼Œä½¿ç”¨ Markdown æ ¼å¼ï¼Œå¹¶åˆ©ç”¨å˜é‡å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
          body: |
            ğŸš€ **Release v${{ env.EXTENSION_VERSION }}**
          # è‡ªåŠ¨ç”Ÿæˆ Release Notes
          generate_release_notes: true
        env:
          # GITHUB_TOKEN æ˜¯ GitHub Actions è‡ªåŠ¨æä¾›çš„ Secretï¼Œç”¨äºè®¤è¯è¿›è¡Œ API è°ƒç”¨ï¼ˆå¦‚åˆ›å»º Releaseï¼‰
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXTENSION_VERSION: ${{ env.EXTENSION_VERSION }}
